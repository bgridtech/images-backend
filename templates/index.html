<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Image</title>
  <style>
    :root {
      --bg: #eef1f6;
      --card-bg: rgba(255, 255, 255, 0.75);
      --accent: #6366f1;
      --accent-dark: #4f46e5;
      --accent-light: #8b5cf6;
      --text: #1e293b;
      --muted: #64748b;
      --success: #10b981;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      height: 100vh; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(120deg, #dfe9f3, #f5f7fa);
      font-family: 'Inter', sans-serif; color: var(--text);
    }
    .upload-card {
      background: var(--card-bg); backdrop-filter: blur(20px);
      border-radius: 20px; padding: 40px 32px; max-width: 420px; width: 100%;
      box-shadow: 0 12px 40px rgba(0,0,0,0.1); text-align: center;
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h1 { font-size: 24px; margin-bottom: 24px; font-weight: 600; }
    .file-input-wrapper {
      position: relative; margin-bottom: 20px;
    }
    .file-input-wrapper input[type="file"] {
      opacity: 0; width: 100%; height: 48px; position: absolute; top: 0; left: 0;
      cursor: pointer;
    }
    .file-label {
      display: block; background: #fff; border: 1px solid #d1d5db;
      border-radius: 10px; padding: 12px; text-align: center;
      color: #4b5563; font-size: 14px; transition: border-color 0.2s;
    }
    .file-input-wrapper:hover .file-label { border-color: var(--accent); }
    button {
      width: 100%; padding: 12px; font-size: 15px; font-weight: 500;
      border: none; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white; cursor: pointer;
      transition: transform 0.2s, background 0.3s;
    }
    button:hover { transform: scale(1.03); }
    button:disabled { background: #cbd5e1; cursor: not-allowed; }
    .info {
      margin-top: 12px; font-size: 14px; color: var(--muted);
    }
    #uploadProgress {
      width: 100%; height: 12px; background: #e2e8f0;
      border-radius: 8px; overflow: hidden; margin-top: 16px; display: none;
    }
    #uploadProgressBar {
      height: 100%; width: 0;
      background: linear-gradient(to right, var(--accent-light), var(--accent));
      transition: width 0.2s ease;
    }
    .url-container {
      position: relative; margin-top: 20px; display: none;
    }
    .url-box {
      width: 100%; padding: 12px 36px 12px 12px; background: #f8fafc;
      border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px;
      word-break: break-all; color: var(--text); text-align: left;
    }
    .copy-icon {
      position: absolute; right: 12px; top: 50%;
      transform: translateY(-50%); cursor: pointer;
      color: var(--muted); font-size: 18px; transition: color 0.2s;
    }
    .copy-icon:hover { color: var(--accent-dark); }
  </style>
</head>
<body>
  <div class="upload-card">
    <h1>Upload Your Image</h1>
    <form id="uploadForm">
      <div class="file-input-wrapper">
        <label class="file-label">Choose image</label>
        <input type="file" id="imageInput" name="image" accept="image/*" required />
      </div>
      <button type="submit" id="uploadBtn">Upload</button>

      <div class="info" id="fileSize"></div>
      <div class="info" id="compressing" style="display:none;">Compressing imageâ€¦</div>
      <div class="info" id="compressedSize"></div>
      <div class="info" id="uploading" style="display:none;">Uploading imageâ€¦</div>
      <div id="uploadProgress"><div id="uploadProgressBar"></div></div>
    </form>

    <div class="url-container" id="urlContainer">
      <div class="url-box" id="result"></div>
      <div class="copy-icon" id="copyIcon" title="Copy URL">ðŸ“‹</div>
    </div>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const imageInput = document.getElementById("imageInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileSizeDiv = document.getElementById("fileSize");
    const compressingText = document.getElementById("compressing");
    const compressedSizeDiv = document.getElementById("compressedSize");
    const uploadingText = document.getElementById("uploading");
    const progressBar = document.getElementById("uploadProgress");
    const progressFill = document.getElementById("uploadProgressBar");
    const urlContainer = document.getElementById("urlContainer");
    const resultDiv = document.getElementById("result");
    const copyIcon = document.getElementById("copyIcon");

    form.addEventListener("submit", async e => {
      e.preventDefault();
      const file = imageInput.files[0];
      if (!file) return;

      fileSizeDiv.textContent = `Original size: ${(file.size/1024/1024).toFixed(2)} MB`;
      uploadBtn.disabled = true;
      urlContainer.style.display = "none";
      resultDiv.textContent = "";
      compressingText.style.display = "none";
      compressedSizeDiv.textContent = "";
      uploadingText.style.display = "none";
      progressBar.style.display = "none";
      progressFill.style.width = "0%";

      let finalFile = file;
      if (file.size > 3*1024*1024) {
        compressingText.style.display = "block";
        finalFile = await compressImage(file);
        compressingText.style.display = "none";
        compressedSizeDiv.textContent = `Compressed size: ${(finalFile.size/1024/1024).toFixed(2)} MB`;
      }

      const formData = new FormData();
      formData.append("image", finalFile);

      uploadingText.style.display = "block";
      progressBar.style.display = "block";

      const xhr = new XMLHttpRequest();
      xhr.open("POST","/upload");
      xhr.upload.onprogress = e => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded/e.total)*100);
          progressFill.style.width = pct + "%";
        }
      };
      xhr.onload = () => {
        uploadBtn.disabled = false;
        uploadingText.style.display = "none";
        const res = JSON.parse(xhr.responseText);
        resultDiv.textContent = res.url || res.error || "Upload failed.";
        urlContainer.style.display = "block";
      };
      xhr.onerror = () => {
        uploadBtn.disabled = false;
        uploadingText.style.display = "none";
        resultDiv.textContent = "Upload error.";
        urlContainer.style.display = "block";
      };
      xhr.send(formData);
    });

    copyIcon.addEventListener("click", () => {
      const txt = resultDiv.textContent;
      navigator.clipboard.writeText(txt).then(() => {
        copyIcon.textContent = "âœ…";
        setTimeout(() => copyIcon.textContent = "ðŸ“‹", 1000);
      });
    });

    function compressImage(file) {
      return new Promise(resolve => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.src = url;
        img.onload = () => {
          const max = 1024;
          let w = img.width, h = img.height;
          if (w>max||h>max) {
            const scale = Math.min(max/w, max/h);
            w*=scale; h*=scale;
          }
          const c = document.createElement("canvas");
          c.width=w; c.height=h;
          c.getContext("2d").drawImage(img,0,0,w,h);
          c.toBlob(b=> resolve(new File([b],file.name,{type:file.type})), file.type, 0.8);
        };
      });
    }
  </script>
</body>
</html>
